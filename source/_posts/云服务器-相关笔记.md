---
title: 云服务器-相关笔记
date: 2023-01-05 17:54:14
tags:
- 云服务器
categories: 
- 服务器
- 云服务器
---

[轻量应用服务器](https://cloud.tencent.com/document/product/1207)

[文档中心](https://jcloud.sjtu.edu.cn/document/index.html)

#### [云主机](https://jcloud.sjtu.edu.cn/document/detail.html?mod=cvm&id=622)——文档

[快速创建 Linux云主机](https://jcloud.sjtu.edu.cn/document/detail.html?mod=qstart&id=1029)

[Linux命令大全](https://linux265.com/course/linux-commands.html) 

#### [CentOS-download](https://www.centos.org/download/)

CentOS是免费的、开源的、可以重新分发的开源操作系统

我的腾讯云服务器安装的是`CentOS 7.6`

#### [CentOS 7 配置SFTP](https://www.cnblogs.com/yyy-blog/p/11130302.html)

一、sftp 安装

二、sftp 简单操作

测试

```
sftp silent@127.0.0.1
silent@127.0.0.1's password: 
```

[centos7如何重启ssh服务](http://bjst.net.cn/ask/show-393511.html)

重启ssh服务 ——`慎用`

```
service sshd restart     
```

查看ssh服务状态

```
systemctl status sshd.service
```

开启ssh服务

```
systemctl start sshd.service
```

设置ssh服务开机自启

```
systemctl enable sshd.service
```

[命令行启动ssh_【树莓派】系统启用SSH服务](https://blog.csdn.net/weixin_35733852/article/details/112624508)

[ubuntu安装ssh并开机启动](https://doc.wendoc.com/bf17d393bee91e5e9e26bcf34593ac5ebb69e2e46.html)



#### 协议端口

[云服务器需要开放哪些端口](https://www.niuqi360.com/webmaster/the-common-vps-server-logical-port/)

协议端口支持以下格式：

- 单个端口: TCP:80
- 多个端口: UDP:80,443
- 连续端口: TCP:3306-20000
- 所有端口：ALL
- 协议端口(组)ID: ppm-1234ilbd
- 其它协议：ICMP，ICMPv6或GRE



#### [网站备案](https://console.cloud.tencent.com/beian/manage)

1. 身份证复印件摁手印
2. 广东省个人网站备案承诺书，主体负责人本人需手写日期＋签名(接受签名章，不接受连笔签)+按手印。
3. 网站名称
4. 联系方式

##### 备案材料

- 域名证书
- 域名实名认证截图
- 暂住证/居住证
- 网站建设方案书

#### 云服务器配置https协议

##### 一、SSL证书申请

1. 在`阿里云`中搜`SSL`，进去`SSL证书（应用安全）`  （域名在阿里云买的）

2. SSL证书——免费证书——创建证书

   ![创建证书](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/%E9%98%BF%E9%87%8C%E4%BA%91%E8%B4%AD%E4%B9%B0%E5%85%8D%E8%B4%B9SSL%E8%AF%81%E4%B9%A6.png)

3. 证书申请：点击”证书申请“，填写证书绑定域名，域名验证方式（选择自动DNS验证），CSR生成方式（选择系统生成）等信息

   ![证书申请](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E5%AE%A1%E6%A0%B81.png)
   ![证书申请](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E7%94%B3%E8%AF%B7%E5%AE%A1%E6%A0%B8.png)


4. 验证信息（申请完之后，会返回相关的配置信息），域名授权验证类型，记录类型，主机记录，记录值等信息。需要在`阿里云——域名解析——解析设置`中添加一条记录，将以上信息填写进去

   `返回的配置信息：`

   ![返回的配置信息](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E5%AE%A1%E6%A0%B83.png)

   `添加记录：`

   - 如果在解析设置中，自动加好这条记录，就不需要手动添加

   - 如果在解析设置中，没有这条记录，要手动添加

   ![添加记录](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90-%E6%B7%BB%E5%8A%A0%E8%AE%B0%E5%BD%95.png)

5. 刷新SSL证书页面，证书的状态就变成了`已签发`

   ![已签发](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E5%AE%A1%E6%A0%B84--%E5%B7%B2%E7%AD%BE%E5%8F%91.png)

##### 二、服务器证书安装前的准备

1. 证书签发成功，会收到阿里云发送的邮件
   1. 在`阿里云——SSL证书——免费证书`的列表中的操作列中`下载`证书，我下载的是`pem格式`，因为我的`腾讯云`服务器是Nginx的（服务器在腾讯云买的）
   
      ![下载证书](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/%E4%B8%8B%E8%BD%BDSSL%E8%AF%81%E4%B9%A6.png)
   
   2. 确定您的证书是需要安装至Web服务器还是部署到阿里云云产品上
      1. 下载并安装至Web服务器，请点击 https://help.aliyun.com/document_detail/198938.html （我这里选择这个）
      2. 一键部署到阿里云云产品，请点击 https://help.aliyun.com/document_detail/98575.html
2. 选择 [在Nginx或Tengine服务器上安装证书](https://help.aliyun.com/document_detail/98728.html?spm=a2c4g.11186623.0.0.2bd24c010kqjxk) 文档——因我的服务器是使用`腾讯云的Nginx虚拟机`

   - 在`腾讯云`中搜索    [如何安装 SSL 证书](https://cloud.tencent.com/document/product/1207/54869)  ——> 选择 [Nginx 服务器证书安装](https://cloud.tencent.com/document/product/1207/47027)

   > 如果您使用的是其他品牌的虚拟主机，请参考对应的虚拟主机安装证书的操作指

##### 三、服务器SSL证书安装

1. 查找`nginx`所在的目录（我云服务器中的nginx目录跟文档中的目录不一样）

   ```
   whereis nginx
   ```

2. 找到`nginx.conf`所在目录（我云服务器的`nginx.conf`在`/etc/nginx`）

3. 编辑 Nginx 默认配置文件目录中的 `nginx.conf` 文件

   ```
   cd /etc/nginx
   ```

   ```
   vi nginx.conf
   ```

4. 上传证书文件名称和私钥文件名称到`/etc/nginx`目录

   ```
   rz -y
   ```

5. 将以下代码的`注释去掉`（原本以下代码是被注释掉的）

   ```
   server {
       listen       443 ssl http2;
       ........
       ........
   }
   ```

6. 修改`server{...}`里面的证书文件名称和私钥文件名称

   `注意：语句的后面要加;（分号）`

   ```
   // 原来的配置
   // ssl_certificate "/etc/pki/nginx/server.crf";
   // ssl_certificate_key "/etc/pki/nginx/private/server.key";
   
   // 修改后
   ssl_certificate "/etc/nginx/******.pem";
   ssl_certificate_key "/etc/nginx/******.key";
   ```

7. 找到 `http{...}`，并输入以下配置信息

   `注意：语句的后面要加;（分号）`

   ```
   ssl_certificate ******.pem;   # 填写您的证书文件名称
   ssl_certificate_key ******.key;    # 填写您的私钥文件名称
   ```

8. 保存修改后的 `nginx.conf` 文件后退出

   > 按esc退出编辑模式

   ```
   :wq
   ```

9. 执行以下命令，验证配置文件是否存在问题

   > 登录的是`root`账户，可以不使用`sudo`

   ```
   sudo nginx -t
   ```
   
   若输出信息如下所示，则为配置成功，请继续执行
   
   ```
   nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
   nginx: configuration file /etc/nginx/nginx.conf test is successful
   ```
   
10. 执行以下命令，重启 `Nginx`

    ```
    sudo systemctl reload nginx
    ```

    至此已安装成功。您可使用 `https://cloud.tencent.com`（示例）正常进行访问。

    ![配置成功显示的页面](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png)

11. 修改`https://******.com`访问的默认页面

    ```
    server {
        listen       443 ssl http2;
        listen       [::]:443 ssl http2;
        server_name  _;
       # root         /usr/share/nginx/html;   # 原来填写的路径
        root         /usr/webcode/wx;   # 在wx目录中新建index.html内容
    }
    ```




##### 下载文件

```
sz api3.js       // sz 文件名
```

##### 设置 HTTP 请求自动跳转 HTTPS（可选）

```
server_name  www.winney07.cn;
return 301 https://$host$request_uri;
```

输入`nginx.conf`之后，报以下警告

```
nginx: [warn] conflicting server name "www.winney07.cn" on 0.0.0.0:80, ignored
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
[root@VM-8-7-centos nginx]# systemctl reload nginx
```

改为

```
server_name  winney07.cn;
return 301 https://$host$request_uri;
```

#### [linux如何开启ssh服务](https://www.kufanyun.com/idcnews/1384.html)

[Linux SSH 服务配置与管理](https://zhuanlan.zhihu.com/p/525614499)

#### CentOS 7 配置SFTP

[CentOS 7 配置SFTP](http://hk.javashuo.com/article/p-yessuomw-cb.html)

[CentOS 7 配置SFTP](http://www.javashuo.com/article/p-yessuomw-cb.html)

[centos7 sftp分配用户](https://blog.csdn.net/qq_32534855/article/details/115468504)

[CentOS 7 配置SFTP](https://www.lmlphp.com/user/57795/article/item/600744/)





### 命令

列出正在使用的端口以及使用它们的程序

```
netstat -tulpn
```



[Linux 命令（83）—— groups 命令](https://blog.csdn.net/K346K346/article/details/102842260)

```
groups root   // 显示root组成员
```

```
groups winney

// winney : sftp      // 控制台输出的内容
```

#### ssh

```
which ssh
```

```
which sshd
```

[ssh -V和openssl version 看到版本不一致问题解决](https://blog.csdn.net/lijq3370/article/details/117087061)

```
ssh -V
```

```
openssl version
```

[学习Linux命令:关于ssh命令](https://blog.csdn.net/weixin_45707610/article/details/127050436)

> SSH客户端及其相应的版本号。使用ssh -V命令可以得到版本号

#### [setenforce 0,setenforce命令](https://www.zhangshilong.cn/work/288868.html)

setenforce是Linux的selinux防火墙配置命令， 执行setenforce 0 表示关闭selinux防火墙。

#### 修改密码

```
password winney      // 修改winney用户的密码   （输入密码的时候，是不显示的密码的）
```

#### 查看当前所在目录

```
pwd

/root/test           #输出结果
```

> 执行 pwd 指令可立刻得知您目前所在的工作目录的绝对路径名称。

#### groups

显示当前用户所属的组

```
groups
```

[Linux 命令（83）—— groups 命令](https://blog.csdn.net/K346K346/article/details/102842260)

#### ll

```
ll
```

> “ls -l” "ls -al" ll 用来查询当前目录下文件及目录的详情

[Linux “ll“ 命令详解](https://blog.csdn.net/weixin_40170142/article/details/123913437)

#### [SSH密钥方式远程登录Linux云主机](https://jcloud.sjtu.edu.cn/document/detail.html?mod=cvm&id=1291)

执行如下命令，登录弹性云服务器。

```
ssh -i /path/kp-123.pem root@云主机公网IP
```

假设Linux云主机公网IP为：`123.123.123.123`，则命令如下：

```
ssh -i /path/kp-123.pem root@123.123.123.123
```

> 在git命令窗口，切换到密钥文件所在的路径，执行命令

说明：

- path为密钥文件的存放路径。
- 弹性公网IP地址为云主机绑定的公网IP地址。



#### 云服务器-express搭建

文件存放目录：`/usr/local/src/webCode/wx`

1. 上传`api.zip`压缩文件

   ```
   rz
   ```

2. 解压压缩文件

   ```
   unzip api.zip
   ```



#### [腾讯云开放端口问题](https://cloud.tencent.com/developer/article/1841261?areaSource=103001.11&traceId=uySRixqZ2EeSmbrM2RznL)

[Centos防火墙开放端口](https://cloud.tencent.com/developer/article/2040629?areaSource=103001.30&traceId=DmIbyYtUlIXk-cJMi9MlS)

[windows查看指定的端口是否开放](https://cloud.tencent.com/developer/article/2139609?from=15425&areaSource=102001.1&traceId=-ZYYPIBPO6KpfJkEVE-sS)

[腾讯云轻量应用服务器开放端口方法，附最新腾讯云优惠券活动](https://weibo.com/ttarticle/p/show?id=2309404847970762752353)

[腾讯云轻量服务器开放端口方法教程](https://zhuanlan.zhihu.com/p/411605768)

[添加防火墙规则](https://cloud.tencent.com/document/product/1207/48254?fromSource=gwzcw.1293314.1293314.1293314&cps_key=38b75278ba66c442798625a2a46beb05)

```
telnet ip地址  8080（端口号）
```

> telnet命令不存在启用方式 1.打开运行窗口 按住键盘上的win键,再按R键,即可打开运行窗口 1
>
> 2.打开Windows功能对话框 在运行对话框中输入 optionalfeatures  然后再点击确认,即可打开Windows功能对话框
>
> 3.在Windows功能对话框中找到 telnet客户端 ,并在其前方的空格中打勾选择,然后点击确认即可开启telnet客户端功能



#### Centos 防火墙操作

查看下服务器上开放的端口：

```javascript
firewall-cmd --zone=public --list-ports
```

将8080端口加入到开放端口中：

```
firewall-cmd --zone=public --add-port=8080/tcp --permanent
```

再查看下服务器上开放的端口：

```
firewall-cmd --zone=public --list-ports
```

[腾讯云开放端口后仍然无法访问](https://blog.csdn.net/Tingnichui/article/details/127329913)

```
firewall-cmd --zone=public --query-port=8080/tcp
```

#### 腾讯云服务器端口开放了仍无法访问的解决方法

[腾讯云服务器tomcat端口无法访问的解决方法_Tomcat](https://www.anquanclub.cn/5197.html)

[https://console.cloud.tencent.com/cvm/securitygroup](https://www.anquanclub.cn/?golink=aHR0cHM6Ly9jb25zb2xlLmNsb3VkLnRlbmNlbnQuY29tL2N2bS9zZWN1cml0eWdyb3Vw)需要去这个地址设置安全组。

1. 添加安全组

   添加完之后，再本地cmd命令窗口，输入`telnet  ip地址   8080（端口号）`  就可以连接成功，不然会显示连接失败



[微信小程序接口请求 报错ERR_SSL_PROTOCOL_ERROR](https://blog.csdn.net/henry2k888/article/details/111625844)

[微信小程序发起请求ERR_SSL_PROTOCOL_ERROR](https://developers.weixin.qq.com/community/develop/doc/00006ce98688285e69782f55a5bc00)

[微信小程序发起请求ERR_SSL_PROTOCOL_ERROR](https://developers.weixin.qq.com/community/develop/doc/00006ce98688285e69782f55a5bc00)

[开发微信小程序之HTTPS报错常见问题汇总及解决方法](http://blog.itpub.net/31483669/viewspace-2696094/)

#### [微信开发者工具 GET net::ERR_SSL_PROTOCOL_ERRO](https://www.cnblogs.com/fhysy/p/14760724.html)

解决方法：

1. 将微信小程序页面中的接口链接中的`https`协议改为`http`协议
2. 在微信开发者工具中，`详情—本地设置`中，将`不校验合法域名、web-view (业务域名)、TLS版本以及 HITPS证书`这个选项勾选上
3. 重新访问，接口就返回正常

> 如果在前后端分离场景下，可能是你微信小程序的baseurl配置错误了，微信端请求的baseurl应该是http开头的而不是https
> 检查你微信小程序配置host地址的文件，看看host是不是http开头的



[如何修复FTP连接服务器提示ECONNREFUSED错误](https://www.wbolt.com/econnrefused-connection-refused-by-server.html)

[开发微信小程序之HTTPS报错常见问题汇总及解决方法](http://blog.itpub.net/31483669/viewspace-2696094/)

[游览器出现net::ERR_SSL_PROTOCOL_ERROR错误的解决](https://blog.csdn.net/qq_41967899/article/details/90442946)

[nginx https配置后无法访问，可能防火墙在捣鬼](http://wjhsh.net/lxwphp-p-15454788.html)

百度搜 “腾讯云 后端 https接口 ”   “腾讯云 后端(express） https接口 ”  

[利用腾讯云免费SSL证书配置 nginx https 接口服务](https://www.bilibili.com/read/cv18859068/)

[https之ssl证书配置前端+后端（koa）](https://cloud.tencent.com/developer/article/2085371)

[node+express编写后端接口，部署到服务器上，并配置nginx+ssl证书，实现https访问](https://blog.csdn.net/weixin_40496794/article/details/122979654)

[express启用https使用小记](https://www.gxlcms.com/JavaScript-63367.html)

[https服务搭建](https://blog.csdn.net/qq_25944759/article/details/107922064)



#### SSL协议错误

**net::ERR_SSL_PROTOCOL_ERROR-----报错的解决方法**

[express应用HTTPS总结](https://www.jianshu.com/p/e83186622054/)  —— express 写的https接口，最终解决方法在这里

> 百度搜  “腾讯云 后端(express） https接口   net::ERR_SSL_PROTOCOL_ERROR”

> 最重要的是 express要使用`https`模块 ` var https=require('https');`

启用https的服务器上运行了http服务，在申请https后没有将express应用由默认的http更换为https，将下方代码加入到app.js中修改一下路径即可

```
// 引入部分
const express=require('express');
const bodyParser=require('body-parser');
const cors=require("cors");
const session=require("express-session");
// const userRouter=require("./routes/user");
const fs=require('fs');
//创建web服务器
var server=express();
// server.listen(3000);
var http=require('http');
var https=require('https');

//根据项目的路径导入生成的证书文件下面的key和pem是下载证书得到的
var privateKey  = fs.readFileSync('key.key', 'utf8');
var certificate = fs.readFileSync('pem.pem', 'utf8');
var credentials = {key: privateKey, cert: certificate};
 
var httpServer = http.createServer(server);
var httpsServer = https.createServer(credentials, server);
 
//可以分别设置http、https的访问端口号
var PORT = 3000;
var SSLPORT = 3001;
 
//创建http服务器
httpServer.listen(PORT, function() {
    console.log('HTTP Server is running on: http://localhost:%s', PORT);
});
 
//创建https服务器
httpsServer.listen(SSLPORT, function() {
    console.log('HTTPS Server is running on: https://localhost:%s', SSLPORT);
});
 
//可以根据请求判断是http还是https
server.get('/', function (req, res) {
    if(req.protocol === 'https') {
        res.status(200).send('This is https visit!');
    }
    else {
        res.status(200).send('This is http visit!');
    }
});


//使用body-parser中间件
server.use(bodyParser.urlencoded({
    extended:false
}))
//托管静态目录
server.use(express.static("public"))
//解决跨域问题
server.use(cors({
    origin:["http://127.0.0.1:8081","http://localhost:8081","http://127.0.0.1:8080","http://localhost:8080"],
    credentials:true
}))
// session功能
server.use(session({
    secret:"128字符串",
    resave:true,
    saveUninitialized:true
}))
//挂载路由
// server.use('/user',userRouter);
```

上传证书和密码到接口相关目录

```
cd /usr/local/src/webCode/wx
mkdir private
cd private
rz -y   // 上传证书和密码文件
```



#### 微信小程序接口报错：`RR_SSL_PROTOCOL_ERROR`，最终解决代码如下：

`/usr/local/src/webCode/wx/api3.js`

```
// 引入部分
const express=require('express');
const bodyParser=require('body-parser');
const cors=require("cors");
const session=require("express-session");
// const userRouter=require("./routes/user");
const fs=require('fs');
//创建web服务器
var server=express();
// server.listen(3000);
var http=require('http');
var https=require('https');

//根据项目的路径导入生成的证书文件下面的key和pem是下载证书得到的
var privateKey  = fs.readFileSync('./public/www.winney07.cn.key', 'utf8');
var certificate = fs.readFileSync('./public/www.winney07.cn.pem', 'utf8');
var credentials = {key: privateKey, cert: certificate};
 
var httpServer = http.createServer(server);
var httpsServer = https.createServer(credentials, server);
 
//可以分别设置http、https的访问端口号
var PORT = 8081;
var SSLPORT = 8080;
 
//创建http服务器
httpServer.listen(PORT, function() {
    console.log('HTTP Server is running on: http://localhost:%s', PORT);
});
 
//创建https服务器
httpsServer.listen(SSLPORT, function() {
    console.log('HTTPS Server is running on: https://localhost:%s', SSLPORT);
});
 
//可以根据请求判断是http还是https
server.get('/', function (req, res) {
    console.log(req.protocol);
    if(req.protocol === 'https') {
        res.status(200).send('This is https visit!');
    }
    else {
        res.status(200).send('This is http visit!');
        console.log('进来http------');
    }
});

server.get('/user', function (req, res) {
    res.status(200).send('winney');
});


server.get('/user/:id', function (req, res, next) {
    console.log('req.params')
    console.log(req.params)
    res.status(200).send('winney---' +  req.params.id);
})


server.post('/news', function (req, res) {
    console.log('req.body')
    console.log(req.data)
    res.status(200).send({
        state: 'success',
        data: req
    });
})

//使用body-parser中间件
server.use(bodyParser.urlencoded({
    extended:false
}))
//托管静态目录
server.use(express.static("public"))
//解决跨域问题
server.use(cors({
    origin:["http://127.0.0.1:8081","http://localhost:8081","http://127.0.0.1:8080","http://localhost:8080"],
    credentials:true
}))
// session功能
server.use(session({
    secret:"128字符串",
    resave:true,
    saveUninitialized:true
}))
//挂载路由
// server.use('/user',userRouter);
```

##### 微信小程序代码：

```
wx.request({
  url: 'https://域名:8080',  
  data: {},
  header: {
    'content-type': 'application/json' // 默认值
  },
  success (res) {
    console.log('接口返回的数据')
    console.log(res)
  },
  fail(err) {
    console.log(err)
  }
})
```

##### node命令使用之前：

```
 nvm  use 16.13.0
```

```
cd /usr/local/src/webCode/wx
```

```
node book.js
```

##### 解决报错

报错：`MongooseServerSelectionError: Server at 127.0.0.1:27017 reports maximum wire version 5, but this version of the Node.js Driver requires at least 6 (MongoDB 3.6)`

原因：`mongoose的版本太高（v7.*），需要mongoDB3.6及以上版本，但我云服务器安装太高版本的mongoDB运行有问题，需要配置其他东西`

解决方法：将mongoose的版本降低

```
npm i mongoose@5.13.0 --save
```

再次运行

```
node book.js
```

控制台成功打印：

```
{
  _id: 642650ee5d48a1118feb04d1,
  name: '张三AAAAAA',
  age: 18,
  sex: '男',
  __v: 0
}
```

`现在微信小程序连接云服务器https接口成功了，云服务mongoose连接mongodb成功了`



###### 查看mongodb版本

```
mongo -version

MongoDB shell version v3.4.24
```





#### 待整理命令：

```
vi /etc/sysconfig/iptables
sudo vi /etc/sysconfig/iptables
ssh -V
groupadd sftp
sudo useradd -g sftp -s /sbin/nologin silent
sudo useradd -g sftp -s /sbin/nologin silent     // 再执行一次，可以看到useradd: user 'silent' already exists
cd /data/
ll
```

接：

```
sudo mkdir -p /data/sftp/silent
sudo usermod -d /data/sftp/silent silent
sudo vi /etc/ssh/sshd_config
sudo chown root:sftp /data/sftp/silent
sudo chmod 755 /data/sftp/silent
sudo mkdir /data/sftp/silent/upload
sudo chown silent:sftp /data/sftp/silent/upload
sudo vi /etc/selinux/config
sudo setenforce 0


sudo chmod 755 /data/sftp/silent/upload
```



[MongoDB：安装配置](https://cloud.tencent.com/developer/article/2204018)

[MongoDB 安装配置](https://cloud.tencent.com/developer/article/1392673)

[使用腾讯云服务器快速搭建MongoDB数据库](https://www.dnjc.cc/m/104600.html)

[MongoDB的安装与使用（一）](https://cloud.tencent.com/developer/news/386130)



[CentOS7.6 腾讯云服务器安装MongoDB 5.05](https://blog.csdn.net/weixin_44843687/article/details/122222609)

[腾讯云CentOs搭建NodeJs服务器—安装 mongodb](https://juejin.cn/post/6860424108732055560)



[腾讯云CentOS 7.2 64位安装Mongodb](https://www.gxlcms.com/sql_question-406163.html)

[腾讯云服务器CentOS7 安装mongodb](https://www.cnblogs.com/woju/p/15670404.html)

[腾讯云服务器（CentOS)安装配置mongodb](https://www.jianshu.com/p/870aeeabf61e)

[腾讯云服务器CentOS7 安装mongodb](http://www.zyiz.net/tech/detail-268723.html)

[腾讯云~安装MongoDB](https://www.pudn.com/news/62aef03fca7ee606dcd336d0.html)

[如何在Linux上下载MongoDB](https://blog.csdn.net/qq_54783667/article/details/123986420)

[Linux平台安装MongoDB](https://www.runoob.com/mongodb/mongodb-linux-install.html)

[Linux平台安装MongoDB](https://blog.csdn.net/mouday/article/details/90670432)

[MongoDB安装包下载](https://www.mongodb.com/try/download/shell)

### Linux安装MongoDB的详细过程

参考[Linux安装MongoDB（简单详细）](https://blog.csdn.net/weixin_38568503/article/details/127885059)

1. [MongoDB官网](https://www.mongodb.com)，选择社区（Community Edition）

   ![进去社区](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/0-%E8%BF%9B%E5%8E%BB%E7%A4%BE%E5%8C%BA.png)



2. 选择对应的安装包：https://www.mongodb.com/try/download/community

   ![选择包](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/0%E9%80%89%E6%8B%A9%E5%8C%85.png)

3. 复制下载链接

4. 在服务器`/usr/local`下创建mongodb目录

   > （我是为了避免文件太乱，在mongodb目录中下载，也可以不用这样操作）

   ```
   cd /usr/local
   mkdir mongodb
   cd mongodb
   ```

5. 执行下载命令：

   ```
   wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.24.tgz
   ```

   ```
   ls       // 可以看到在目录中
   ```

![下载成功](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/1.%E4%B8%8B%E8%BD%BD.png)

6. 解压

   ```
   tar -zxvf mongodb-linux-x86_64-rhel70-3.4.24.tgz
   ```

   ```
   ls   // 
   ```

![解压成功](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/2.%E8%A7%A3%E5%8E%8B%E6%88%90%E5%8A%9F.png)

7. 移动 MongoDB 安装目录（重命名，移动解压后的文件到`mongodb3.4`）

   > 将解压后的 mongodb-linux-x86_64-rhel70-3.4.24 中的所有文件全部移动到 `/usr/local/mongodb3.4 `中 。注意：`/*`是所有子文件

   > 我根据mongodb的版本，在`/usr/local`下重新创建一个mongodb3.4目录，因为我在mongodb目录中下载了好多个安装失败的包，避免错乱。  如果你直接安装3.4.24版本的，可以不用创建mongodb3.4目录，直接将解压后的东西，移到mongodb目录就行。
   >
   > 即：mv mongodb-linux-x86_64-rhel70-3.4.24/*  /usr/local/mongodb
   
   ```
   mkdir mongodb3.4
   
   mv mongodb-linux-x86_64-rhel70-3.4.24/* /usr/local/mongodb3.4
   ```

![移动解压后的文件](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/3%E9%87%8D%E5%91%BD%E5%90%8D--%E7%A7%BB%E5%8A%A8%E8%A7%A3%E5%8E%8B%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6.png)

8. 设置 MongoDB 环境变量

   配置环境变量的启动：
   
   ```
   vim /etc/profile
   ```
   
   在文件中增加以下配置：
   
   ```
   export MONGODB_HOME=/usr/local/mongodb3.4
   export PATH=$MONGODB_HOME/bin:$PATH
   ```
   
   > 我是添加在文件的最后面

9. 使系统环境变量立即生效

   ```
   source /etc/profile
   ```

10. 验证是否成功

    ```
    mongo -version
    ```

    成功会显示以下内容：

    ```
    MongoDB shell version v3.4.24
    git version: 865b4f6a96d0f5425e39a18337105f33e8db504d
    OpenSSL version: OpenSSL 1.0.1e-fips 11 Feb 2013
    allocator: tcmalloc
    modules: none
    build environment:
        distmod: rhel70
        distarch: x86_64
        target_arch: x86_64
    ```

    如图：

    ![安装成功](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/4.%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E9%85%8D%E7%BD%AE--%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F.png)

    > 安装成功 可以使用mongod mongo 等等命令直接进行操作

11. 创建 MongoDB 必要目录

    在`mongodb3.4`目录下创建data和logs目录，以及日志文件mongodb.log

    ```
    cd mongodb3.4 #进入文件夹
    mkdir data
    mkdir logs
    
    cd data
    mkdir db
    
    touch /usr/local/mongodb/logs/mongodb.log
    // 或者
    cd logs
    vi mongodb.log      // 创建文件    要使用:wq 保存退出才创建成功
    ```

12. 添加 MongoDB 配置文件

    ```
    vim /etc/mongodb.conf
    ```

    添加一下常用配置：

    > 下面的mongodb目录改为==》mongodb3.4(我设置的目录)

    `mongodb.conf`的内容

    ```
    #数据存储路径
    dbpath=/usr/local/mongodb3.4/data/db
    #日志文件路径
    logpath=/usr/local/mongodb3.4/logs/mongodb.log
    #端口号
    port=27017
    fork=true
    journal=false
    storageEngine=mmapv1
    ```

13. 启动和关闭 MongoDB

    启动MongoDB（-conf 使用配置文件方式启动）

    ```
    mongod --config /etc/mongodb.conf
    ```

    关闭MongoDB（-conf 使用配置文件方式关闭 ）

    ```
    mongod --shutdown -f /etc/mongodb.conf
    ```



#### 报错信息处理

启动失败，报错信息：

![启动失败](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/5.%E5%90%AF%E5%8A%A8MongoDB-%E5%A4%B1%E8%B4%A5.png)

> 原因：端口号冲突 
>
> 可以查看是否有进程占用该端口，修改端口，重新执行`mongod --config /etc/mongodb.conf`
>
> 解决方案：杀死进程，重新执行
>
> 解决方案：通过mongod --repair检查具体错误

查看进程：

```
netstat -tpnl
```

![查看进程](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/6.%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B.png)

杀死进程：

> 可以杀死进程来关闭：kill -2 或者kill -15 进程号

````
kill -2 11672
kill -2 23771
kill -2 21206
kill -2 13084
````

> 这么多个mongodb进程，因为我多次修改`/etc/mongodb.conf`里面的端口，又多次执行`mongod --config /etc/mongodb.conf` 

再次执行`netstat -tpnl`，就看不到有`mongodb`的进程了

```
netstat -tpnl
```

再次执行`mongod --config /etc/mongodb.conf`

成功界面如图：

![成功](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/7.%E5%86%8D%E6%AC%A1%E5%90%AF%E5%8A%A8MongoDB-%E6%88%90%E5%8A%9F.png)



测试mongo

```
mongo
```

![mongo](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/8.mongo%E6%B5%8B%E8%AF%95.png)

#### 在MongoDB Shell中的使用

- MongoDB Shell 是 MongoDB 自带的一种交互式 JavaScript 命令行管理工具

- 可以通过 MongoDB shell 或者各语言驱动访问数据库，并进行读写、查询等操作

[数据库](https://www.runoob.com/mongodb/mongodb-databases-documents-collections.html)

"show dbs" 命令可以显示所有数据的列表

```
> show dbs
local  0.078GB
test   0.078GB
> 
```

执行 **"db"** 命令可以显示当前数据库对象或集合。

```
> db
test
>
```

运行"use"命令，可以连接到一个指定的数据库。

```
> use local
switched to db local
> db
local
> 
```

本项目中，切换到db目录中，查看里面的数据库文件

```
# cd /usr/local/mongodb3.4/data/db
# ls
// 输出：
admin.0  admin.ns  diagnostic.data  local.0  local.ns  mongod.lock  storage.bson
```

### [读写数据库](https://cloud.tencent.com/document/product/240/64306)

#### 创建数据库

MongoDB 创建数据库的语法格式如下： 

```bash
use DATABASE_NAME
```

创建一个名为 myFirstDB 的数据库，并插入文档。

```bash
> use myFirstDB
switched to db myFirstDB
> db.myFirstDB.insert({"test":"myFirstDB"})
WriteResult({ "nInserted" : 1 })
```

查询已创建的数据库。

```bash
> show dbs
```

#### 创建集合

MongoDB 中使用 createCollection() 方法来创建集合。 语法格式：

```bash
db.createCollection(name, options)
```

参数说明：

name：要创建的集合名称。

options：可选参数, 指定有关内存大小及索引的选项。

| options 字段 | 类型 | 描述                                                         |
| ------------ | ---- | ------------------------------------------------------------ |
| capped       | BOOL | 指是否设置集合的最大字节数。如果为 true，需设置 size 参数。默认为 false。 |
| autoIndexId  | BOOL | 设置是否自动创建索引。如为 true，自动在 _id 字段创建索引。默认为 false。 |
| size         | 数值 | 设置集合的最大字节数。                                       |
| max          | 数值 | 设置集合包含文档的最大数量。                                 |

在 myFirstDB 数据库中创建 FirstCol 集合示例：

```
use myFirstDB
db.createCollection("FirstCol")
```

查看创建的集合：

```bash
> show collections
FirstCol
```

创建集合 FirstCol，最大字节数为 6142800B，文档最大个数为10000个，示例如下：

```
db.createCollection("FirstCol", { capped : true, autoIndexId : true, size : 6142800, max : 10000 } )
```

#### 插入文档

MongoDB 使用 insert() 或 save() 方法向集合中插入文档，示例如下：

```bash
> db.FirstCol.insert({name:"李四",sex:"女",age:25,status:"A"})
```

查看集合中插入的文档：

```bash
> db.FirstCol.find()
```

db.collection.insertMany() 用于向集合插入一个或多个文档，语法格式如下：

```bash
db.collection.insertMany(
 [ <document 1> , <document 2>, ... ]
 )
```

示例如下：

```bash
> db.FirstCol.insertMany([{name:"李三",sex:"女",age:25,status:"A"},{name:"王六",sex:"男",age:26,status:"B"},{name:"王五",sex:"男",age:26,status:"A",groups:["news","sports"]}])
```

#### 更新数据库

MongoDB使用 update() 更新集合中的文档。

更新 FirstCol 集合 name 为李三的数据，示例如下：

```bash
> db.FirstCol.update({name:"李三",sex:"女",age:25,status:"A"},{$set:{'age':28}})
```

查询修改结果：

```
db.FirstCol.find().pretty()
```

#### 删除数据库

MongoDB 使用 remove() 删除集合中的文档。示例如下：

```bash
> db.FirstCol.remove({name:"李三",sex:"女",age:28,status:"A"})
```

查询删除结果：

```bash
> db.FirstCol.find().pretty()
```

更多操作方法，请参见 [MongoDB 官网文档](https://docs.mongodb.com/manual/reference/command/)。

### 连接 MongoDB 实例

[node.js(express)连接mongoDB入门指导](https://www.shuzhiduo.com/A/gVdnwbK8zW/)











#### 报错处理相关知识

```
#查看进程
ps -ef | grep mongod
```

删除文件

```
rm -f mongod.lock
```

  [mongodb: mongod 启动报错[about to fork child process, waiting until server is ready for connections]](https://blog.csdn.net/weixin_36349646/article/details/104993000)

  命令行mongod启动报错

  可能的问题原因：

  - 已经有mongd进程在运行了
  - 配置错误(如dbpath log等)
  - 权限不足等问题
  - mongod.lock文件

  1. 查看是否有进程已经在运行

  ```
  # 方法一 查看进程是否存在
  ps -ef | grep mongod
  
  # 方法二 使用 mongo 命令连接
  # 能成功连接就表明有进程在
  mongo
  ```

一开始安装4.2.8版本的，运行`mongo -version`，报以下类似错误

[/usr/lib64/libssl.so.10: no versioninformation availabl](/usr/lib64/libssl.so.10: no versioninformation availabl)

```
mongo: /usr/lib64/libssl.so.10: no versioninformation available (required by mongo)
mongo: /usr/lib64/libcrypto.so.10: noversion information available (required by mongo)
mongo: /usr/lib64/libcrypto.so.10: noversion information available (required by mongo)
```

原因：**openssl library 不是最新版**

> 解决办法：我安装低版本(3.4.24)的mongodb。因为我不知道升级openssl library ，会对服务器有什么影响

[linux文件重命名命令](https://baijiahao.baidu.com/s?id=1754447517334563145&wfr=spider&for=pc)

[linux怎样判断是文件还是目录](https://www.php.cn/linux-486977.html)

```
 ls -l       // 命令查看文件、目录详细信息
```

当为[ d ]则是目录

当为[ - ]则是文件；

若是[ l ]则表示为链接文档(link file)；

若是[ b ]则表示为装置文件里面的可供储存的接口设备(可随机存取装置)；

若是[ c ]则表示为装置文件里面的串行端口设备，例如键盘、鼠标(一次性读取装置)。



用xshell登录服务器

[腾讯云CentOS7.2部署Express+MongoDB项目](https://www.docin.com/p-2838085923.html)

[我是如何成功搭建 express+mongodb 的简洁博客网站后端的](https://cloud.tencent.com/developer/article/1538013)

[MongoDB + mongo-express 环境搭建记](https://www.cnblogs.com/yelao/p/10792179.html)

#####  mongo shell

如果你需要进入MongoDB后台管理，你需要先打开mongodb装目录的下的bin目录，然后执行mongo命令文件。

MongoDB Shell是MongoDB自带的交互式Javascript shell,用来对MongoDB进行操作和管理的交互式环境。

```
root@qizhuang-virtual-machine:/# mongo
```

运行结果：

```
root@qizhuang-virtual-machine:/# mongo
MongoDB shell version v4.0.9
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("9eb5b47f-f872-4525-8906-8ea79bacd38b") }
MongoDB server version: 4.0.9> # 此处可以进行一些交互式操作
```

###### mongod 配置文件

**注意：**1. ip   2. auth

参考： https://www.cnblogs.com/zhoujinyi/p/3130231.html

 

###### mongodb 角色预授权

注意：1. root角色  2. 在某个库下创建的用户隶属于这个库

参考：https://blog.csdn.net/kk185800961/article/details/45619863

 

###### mongo-express

参考 **centos7下使用mongo-express/adminMongo通过WEB管理MongoDB（可视化）**：https://blog.csdn.net/Algorithmguy/article/details/81905224

**docker mongo-express**：https://docs.docker-cn.com/samples/mongo-express/



[centos7下使用mongo-express/adminMongo通过WEB管理MongoDB（可视化）](https://blog.csdn.net/Algorithmguy/article/details/81905224)

[使用mongo-express图形化界面远程管理数据库](https://www.jianshu.com/p/437626dafad2)

[在CentOS 7(腾讯云)部署node+mongodb项目全过程（上）](https://www.jianshu.com/p/b3b6eb9dc11a)

[在CentOS 7(腾讯云)部署node+mongodb项目全过程（下）](https://www.jianshu.com/p/c0c4ece47556)

使用pm2让nodeJS项目永久运行在服务器上



[如何远程连接mongodb数据库？这四个方法可以轻松实现](https://www.ycpai.cn/python/epmfPZk5.html)

[MongoDB数据库远程配置详解](https://blog.csdn.net/weixin_52908342/article/details/124012409)



#### 宝塔面板

##### 安装

[安装宝塔 Linux 面板](https://cloud.tencent.com/document/product/213/45550)

[安装和配置宝塔 Linux 面板腾讯云专享版](https://cloud.tencent.com/document/product/1207/54078)

[使用 WordPress 应用模板搭建网站](https://cloud.tencent.com/document/product/1207/45117)

安装成功后，会有外网面板地址，需要将地址和账号密码记住

登录之后，创建网站，需要安装nginx或apache。  如果需要FTP功能，还要安装FTP

使用wordpress，还需要安装mysql（选择5.6或5.7版本）、PHP（7.3）

#### 修改后台登录地址

[修改WordPress后台登录地址(wp-admin)的方法](https://98seo.com/wangzhan/433.html)

1. `wp-content/themes/functions.php`

   我是添加在`if ( ! function_exists( 'mynote_setup_theme' ) ) {}`的最后

   ```
   //保护后台登录
   add_action('login_enqueue_scripts','login_protection');  
   function login_protection(){  
       if($_GET['word'] != 'press')header('Location: https://98seo.com/');  
   }
   ```

2. word，press自定义，Location的值为博客网址

3. 最后访问地址：http://98seo.com/wp-login.php?word=press

4. 访问`/wp-admin`/，会默认跳回到首页。

##### [wordpress导入md文件](https://www.wpzt.net/14579.html)

[如何在WordPress中添加自定义CSS样式](http://www.147seo.com/post/12308.html)



##### 卸载：

[宝塔面板卸载方法](https://cloud.tencent.com/developer/article/2256611)

```
wget http://download.bt.cn/install/bt-uninstall.sh

sh bt-uninstall.sh
```

```
[root@VM-8-7-centos ~]# wget http://download.bt.cn/install/bt-uninstall.sh
[root@VM-8-7-centos ~]# sh bt-uninstall.sh
1) 卸载宝塔
2) 卸载宝塔及运行环境(可能影响站点、数据库及其他数据)
*请检查安全类软件是否关闭，否正可能导致无法正常卸载 
=================================================
请选择你要进行的操作(1-2 默认:1): 2

```

```
Complete!
清理完毕
Clean over
Stopping Pure-FTPd...   done
pure-ftpd clean
phpmyadmin clean
清除面板运行环境完毕
Stopping Bt-Tasks...    done
Stopping Bt-Panel...    done
宝塔面板已卸载成功
bt-panel uninstall success
```

