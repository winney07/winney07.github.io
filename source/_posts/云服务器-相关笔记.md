---
title: 云服务器-相关笔记
date: 2023-01-05 17:54:14
tags:
- 云服务器
---

#### 云服务器配置https协议

##### 一、SSL证书申请

1. 在`阿里云`中搜`SSL`，进去`SSL证书（应用安全）`  （域名在阿里云买的）

2. SSL证书——免费证书——创建证书

   ![创建证书](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/%E9%98%BF%E9%87%8C%E4%BA%91%E8%B4%AD%E4%B9%B0%E5%85%8D%E8%B4%B9SSL%E8%AF%81%E4%B9%A6.png)

3. 证书申请：点击”证书申请“，填写证书绑定域名，域名验证方式（选择自动DNS验证），CSR生成方式（选择系统生成）等信息

   ![证书申请](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E5%AE%A1%E6%A0%B81.png)
   ![证书申请](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E7%94%B3%E8%AF%B7%E5%AE%A1%E6%A0%B8.png)


4. 验证信息（申请完之后，会返回相关的配置信息），域名授权验证类型，记录类型，主机记录，记录值等信息。需要在`阿里云——域名解析——解析设置`中添加一条记录，将以上信息填写进去

   `返回的配置信息：`

   ![返回的配置信息](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E5%AE%A1%E6%A0%B83.png)

   `添加记录：`

   - 如果在解析设置中，自动加好这条记录，就不需要手动添加

   - 如果在解析设置中，没有这条记录，要手动添加

   ![添加记录](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90-%E6%B7%BB%E5%8A%A0%E8%AE%B0%E5%BD%95.png)

5. 刷新SSL证书页面，证书的状态就变成了`已签发`

   ![已签发](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E5%AE%A1%E6%A0%B84--%E5%B7%B2%E7%AD%BE%E5%8F%91.png)

##### 二、服务器证书安装前的准备

1. 证书签发成功，会收到阿里云发送的邮件
   1. 在`阿里云——SSL证书——免费证书`的列表中的操作列中`下载`证书，我下载的是`pem格式`，因为我的`腾讯云`服务器是Nginx的（服务器在腾讯云买的）
   
      ![下载证书](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/%E4%B8%8B%E8%BD%BDSSL%E8%AF%81%E4%B9%A6.png)
   
   2. 确定您的证书是需要安装至Web服务器还是部署到阿里云云产品上
      1. 下载并安装至Web服务器，请点击 https://help.aliyun.com/document_detail/198938.html （我这里选择这个）
      2. 一键部署到阿里云云产品，请点击 https://help.aliyun.com/document_detail/98575.html
2. 选择 [在Nginx或Tengine服务器上安装证书](https://help.aliyun.com/document_detail/98728.html?spm=a2c4g.11186623.0.0.2bd24c010kqjxk) 文档——因我的服务器是使用`腾讯云的Nginx虚拟机`

   - 在`腾讯云`中搜索    [如何安装 SSL 证书](https://cloud.tencent.com/document/product/1207/54869)  ——> 选择 [Nginx 服务器证书安装](https://cloud.tencent.com/document/product/1207/47027)

   > 如果您使用的是其他品牌的虚拟主机，请参考对应的虚拟主机安装证书的操作指

##### 三、服务器SSL证书安装

1. 查找`nginx`所在的目录（我云服务器中的nginx目录跟文档中的目录不一样）

   ```
   whereis nginx
   ```

2. 找到`nginx.conf`所在目录（我云服务器的在`/etc/nginx`

3. 编辑 Nginx 默认配置文件目录中的 `nginx.conf` 文件

   ```
   cd /etc/nginx
   ```

   ```
   vi nginx.conf
   ```

4. 上传证书文件名称和私钥文件名称到`/etc/nginx`目录

   ```
   rz -f
   ```

5. 将以下代码的`注释去掉`（原本以下代码是被注释掉的）

   ```
   server {
       listen       443 ssl http2;
       ........
       ........
   }
   ```

6. 修改`server{...}`里面的证书文件名称和私钥文件名称

   `注意：语句的后面要加;（分号）`

   ```
   // 原来的配置
   // ssl_certificate "/etc/pki/nginx/server.crf";
   // ssl_certificate_key "/etc/pki/nginx/private/server.key";
   
   // 修改后
   ssl_certificate "/etc/nginx/******.pem";
   ssl_certificate_key "/etc/nginx/******.key";
   ```

7. 找到 `http{...}`，并输入以下配置信息

   `注意：语句的后面要加;（分号）`

   ```
   ssl_certificate ******.pem;   # 填写您的证书文件名称
   ssl_certificate_key ******.key;    # 填写您的私钥文件名称
   ```

8. 保存修改后的 `nginx.conf` 文件后退出

   > 按esc退出编辑模式

   ```
   :wq
   ```

9. 执行以下命令，验证配置文件是否存在问题

   > 登录的是root账户，可以不使用sudo

   ```
sudo nginx -t
   ```
   
   若输出信息如下所示，则为配置成功，请继续执行
   
   ```
   nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
   nginx: configuration file /etc/nginx/nginx.conf test is successful
   ```
   
10. 执行以下命令，重启 Nginx

    ```
    sudo systemctl reload nginx
    ```

    至此已安装成功。您可使用 `https://cloud.tencent.com`（示例）正常进行访问。

    ![配置成功显示的页面](https://raw.githubusercontent.com/winney07/Images/main/winney07.github.io/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0/SSL%E9%85%8D%E7%BD%AE%E6%88%90%E5%8A%9F.png)

11. 修改`https://******.com`访问的默认页面

    ```
    server {
        listen       443 ssl http2;
        listen       [::]:443 ssl http2;
        server_name  _;
       # root         /usr/share/nginx/html;   # 原来填写的路径
        root         /usr/webcode/wx;   # 在wx目录中新建index.html内容
    }
    ```

    

##### 设置 HTTP 请求自动跳转 HTTPS（可选）

```
server_name  www.winney07.cn;
return 301 https://$host$request_uri;
```

输入`nginx.conf`之后，报以下警告

```
nginx: [warn] conflicting server name "www.winney07.cn" on 0.0.0.0:80, ignored
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
[root@VM-8-7-centos nginx]# systemctl reload nginx
```

改为

```
server_name  winney07.cn;
return 301 https://$host$request_uri;
```





   





